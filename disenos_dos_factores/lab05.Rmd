---
title: "ANOVA con Interacción"
author: "Sebastián Sánchez Sandí"
date: "2025-08-04"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preparación

Los datos para realizar el análisis se encuentran en *torugas2.csv*.

```{r echo=TRUE}
base = read.csv("tortugas2.csv")
str(base)
```

Cambiamos el tipo de genero y cond a factor para poder utilizar las herramientas del análisis.

```{r echo=TRUE}
base$genero = factor(base$especie)
base$cond = factor(base$cond)
levels(base$cond) = c("estricta", "balanceada", "abundancia")
```

## Efectos

Estimamos los efectos simples y de interacción para buscar indicios de interacción.

```{r}
mediaGeneral = mean(base$proteina)
mediaCond = with(data = base, tapply(proteina, cond, mean))
mediaEspecie = with(data = base, tapply(proteina, especie, mean))

alpha = mediaCond - mediaGeneral; alpha
beta = mediaEspecie - mediaGeneral; beta
```

Una vez tenemos los efectos simples calculamos las medias bajo el modelo con interacción y modelo sin interacción para obtener los efectos de interacción.

```{r}
mediaCI = with(data = base, tapply(proteina, list(cond, especie), mean))
cont = 1
mediaSI = c()
for(i in 1:2) {
  for(j in 1:3) {
    mediaSI[cont] = mediaGeneral + alpha[j] + beta[i]
    cont = cont + 1
  }
}

comp = cbind(as.vector(mediaCI), mediaSI)
colnames(comp) = c("MediaCI", "MediaSI")
row.names(comp) = c("e-ch", "b-ch", "a-ch", "e-ky", "b-ky", "a-ky")
comp
```

Como podemos ver en este caso las medias estimadas con un modelo y las medias del otro modelo son relativamente distintas, lo que puede indicar que existe interacción. Construimos un gráfico para visualizar estas diferencias.

```{r}
library(ggplot2)

ggplot(data = base, aes(x = especie, y = proteina, group = cond)) +
  stat_summary(fun = "mean", geom = "line", aes(linetype = cond)) +
  labs(title = "Comparación medias de proteina para cada especie")
```

Gráficamente parece evidente que existe interacción ya que las diferencias entre las medias de proteina para cada condición varia dependiendo de la especie. Podemos obtener directamente los efectos de interacción con el siguiente comando:

```{r}
mod = aov(proteina~cond*especie, data = base)
model.tables(mod)
```

## Varianza del Error

Pasamos a realizar el análisis de la varianza del error para verificar que se cumple el supuesto de homocedasticidad. Construimos un boxplot para visualizar gráficamente la estimación de la varianza de cada tratamiento.

```{r}
boxplot(proteina~cond*especie, data = base)
```

Según el gráfico parece que no se cumple el supuesto de homocedasticidad, pero vamos a realizar la prueba formal.

```{r}
bartlett.test(proteina~interaction(cond, especie), data = base)
```

Como la probabilidad de cometer error tipo 1 es mayor a 0.05, entonces no rechazamos la hipótesis nula. Se espera que si se cumpla el supuesto de homocedasticidad.

## Hipótesis de Interacción

Ahora pasamos a poner a prueba la hipótesis de interacción:

-   $H_0:(\alpha\beta)_{ij}=0$ con $H_a:(\alpha\beta)_{ij}\neq0$

```{r}
mod2 = lm(proteina~cond*especie, data = base)
anova(mod2)
```

Como la probabilidad de cometer error tipo 1 es menor a 0.05, entonces rechazamos la hipótesis nula. Se espera que si exista interacción entre los factores, en otras palabras, el promedio de la proteina generada por la tortuga bajo cada dieta varia dependiendo de la especie.

## Comparaciones bajo el Modelo con Interacción

Como nos quedamos con el modelo con interacción, entonces las comparaciones se realizan entre los niveles del factor de diseño para cada nivel del otro factor. Estas hipótesis serían:

Especie ch:

-   $H_0:\mu_{11}=\mu{21}$
-   $H_0:\mu_{11}=\mu{31}$
-   $H_0:\mu_{21}=\mu{31}$

Especie ky:

-   $H_0:\mu_{12}=\mu{22}$
-   $H_0:\mu_{12}=\mu{32}$
-   $H_0:\mu_{22}=\mu{32}$

Con esto podemos obtener los vectores de los contrastes y de los coeficientes.

```{r}
c1 = model.matrix(mod2)[1,]
c2 = model.matrix(mod2)[5,]
c3 = model.matrix(mod2)[9,]
c4 = model.matrix(mod2)[13,]
c5 = model.matrix(mod2)[17,]
c6 = model.matrix(mod2)[21,]

h1 = c2 - c1
h2 = c3 - c1
h3 = c2 - c3
h4 = c5 - c4
h5 = c6 - c4
h6 = c6 - c5

coef = mod2$coefficients
h = cbind(h1, h2, h3, h4, h5, h6)

L = t(h) %*% coef
L
```

Ahora una vez tenemos los contrastes calculamos la varianza de los estimadores.

```{r}
seL = sqrt(diag(t(h) %*% vcov(mod2) %*% h))
seL
```

Tiene sentido que sea el mismo para todos ya que se cumple el supuesto de homocedasticidad. Con todo esto estandarizamos el estadístico para probar que sean significantes.

```{r}
q = L / seL
round(pt(q, 18, lower.tail = F), 4)
```

Comparamos todas estas probabilades contra $\frac{\alpha}{cd}$ donde c es el número de límites y d el número de comparaciones ya que en cada caso se están realizando 3 comparaciones, si fueran menos el denominador cambia. Este número es 0.017. Rechazamos todas las hipótesis menos una. Calculamos el límite inferior para todos los cuales se encontró diferencia. El estadístico t se busca con una probabilidad de $1 - \frac{\alpha}{cd}$.

```{r}
tc1 = qt(1 - 0.05/3, 18)
tc2 = qt(1 - 0.05/2, 18)

lim1 = round(L[1:3] - tc1 * seL[1:3], 4); lim1
lim2 = round(L[5:6] - tc1 * seL[5:6], 4); lim2
```

En conclusión, con un 95% de confianza se puede afirmar que para el caso de la especie chelonia con una dieta balanceada produce en promedio al menos 6.64 más proteina que la dieta estricta y al menos 3.14 más proteina en promedio que alimento en abundancia. Para la especie kynosternon las tortugas con una dieta estricta y una dieta balanceada no presentan una diferencia significativa, pero las que están bajo alimentación en abundania producen en promedio al menos 2.64 más proteina que bajo alimentación estricta y al menos 0.39 más proteina que dieta balanceada. Es importante destacar que se debe discutir con el investigador si estas diferencias son relevantes para el estudio.
